# Safe Sync Write Protocol

## 目标

为 `sync-card` 和 `sync-project` 提供统一的幂等写入协议，避免：
- 重复插入同一链接；
- 重复创建同名标题；
- 写错分节导致页面结构污染。

## 统一模式

- `sync_mode=strict`：默认且必选。
- strict 模式下，写入必须通过“分节锚定 + 去重检查”。

## 页面分节锚点（Canonical Anchors）

### 主题页（📍）

- 页面路径优先：`02-培养层/📍*.md`
- 兼容路径：`02-培养层/永久笔记/📍*.md`
- 卡片写入主锚点：`## 📚 核心知识`
- 子分节优先级：
  1. 已有匹配 `###`（按 hints/标签）
  2. 无匹配时创建一次 `### 新增卡片`

### 领域页（🌱）

- 页面路径：`03-连接层/🌱*.md`
- 卡片写入锚点：`## 🧠 核心支撑知识` -> `### 关键永久笔记`
- 项目写入锚点：`## 🚀 关联项目` -> `### 活跃项目`

## 去重键（Dedup Key）

对拟写入的 wikilink 计算规范键：
- 优先使用 link target path（`[[path|title]]` 中 `path`）。
- 无 path 时使用 `title`。
- 规范化：去前后空格、统一大小写、去掉可选 `.md` 后缀。

若目标文件任意位置已存在同键链接，则本次写入直接 `skip`。

## 写入算法

1. 定位目标页面（按路径优先级）。
2. 校验主锚点是否存在；不存在则创建一次主锚点。
3. 定位子分节；不存在则创建一次子分节。
4. 执行去重检查（全页 + 目标分节）。
5. 未命中重复时，在目标分节末尾追加单条列表项。
6. 返回 `hit/skip/miss` 明细与原因。

## 标题保护规则

- 禁止创建与现有同名的 `##` / `###` 标题。
- 禁止在同一页面重复创建 `### 关键永久笔记` 或 `### 活跃项目`。
- 发现标题重复风险时，优先复用现有分节并仅插入链接。
- 若页面已历史性存在重复同名标题：仅使用第一处分节写入，并返回 `warning:duplicate-heading-detected`。

## 回归检查（最小）

对同一输入执行两次 `sync-card` 或 `sync-project`：
- 第二次运行应产生 `0` 文件变更；
- 返回结果应以 `skip:already-exists` 为主；
- 不得新增任何标题。
