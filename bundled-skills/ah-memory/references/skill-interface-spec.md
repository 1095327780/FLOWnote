# Skill 接口规范

> 所有 skill 必须遵循的标准接口，确保记忆系统正常工作。

---

## 一、启动阶段（Phase 0）

### 必做事项

每个 skill 启动时，**必须**执行以下操作：

```
1. 读取全局状态文件
   路径：Meta/.ai-memory/全局状态.md

2. 检查相关待处理任务
   - ah-read：检查"阅读整理"区域
   - ah-card：检查"卡片笔记"区域 + "阅读整理"中状态为"待整理卡片笔记"的条目
   - ah-inbox：检查"卡片笔记"区域
   - ah-project：检查"项目"区域
   - ah-review/week/month：检查"回顾"区域

3. 如果有相关待处理任务，提示用户
```

### 提示模板

```
📋 我发现有以下待处理的任务：

1. {{任务描述}}
   来源：{{时间/来源}}

要从这里继续，还是开始新的任务？
- A. 继续{{任务名称}}
- B. 开始新的任务
```

---

## 二、执行阶段

### 进度文件更新时机

在以下节点必须更新进度文件：

| Skill | 更新时机 |
|-------|----------|
| ah-read | 每完成一个批次 |
| ah-card | 每完成一张卡片 |
| ah-project | 每完成一个里程碑 |
| ah-inbox | 每处理完一批收集箱内容 |
| ah-review | 完成回顾时 |

### 进度文件位置

```
Meta/.ai-memory/
├── reading/《书名》.md
├── cards/《来源》.md
├── projects/项目名.md
└── reviews/history.md
```

---

## 三、结束阶段

### 必做事项

每个 skill 结束时，**必须**执行以下操作：

```
1. 更新具体进度文件
   - 标记当前状态
   - 记录下一步建议

2. 更新全局状态文件
   - 更新对应区域的状态
   - 如果产生了新的待处理任务，添加到相关区域
   - 更新"AI 启动提示"区域
```

### 跨 Skill 状态传递

当一个 skill 完成后需要另一个 skill 接手时：

| 来源 Skill | 目标 Skill | 传递方式 |
|------------|-----------|----------|
| ah-read | ah-card | 在"阅读整理"标记"待整理卡片笔记"，同时在"卡片笔记"添加条目 |
| ah-inbox | ah-card | 在"卡片笔记"添加条目 |
| ah-project | ah-archive | 在"项目"标记"待归档" |

---

## 四、全局状态文件格式规范

### 阅读整理区域

```markdown
## 📖 阅读整理

| 书名 | 当前状态 | 下一步 | 优先级 | 进度文件 |
|------|----------|--------|--------|----------|
| 《xxx》| 整理中(3/12批次) | 继续第4批次 | ⭐⭐⭐ | Meta/.ai-memory/reading/《xxx》.md |
```

**状态值**：
- `划线待整理`
- `整理中(N/M批次)`
- `文献笔记已完成`
- `待整理卡片笔记` ← 这个状态表示 ah-card 需要接手
- `已完成`

### 卡片笔记区域

```markdown
## 🃏 卡片笔记

| 来源 | 当前状态 | 待处理数量 | 进度文件 |
|------|----------|------------|----------|
| 《xxx》| 待开始 | 4个洞见 | Meta/.ai-memory/cards/《xxx》.md |
```

**状态值**：
- `待开始`
- `制卡中(N/M张)`
- `已完成`

### 项目区域

```markdown
## 📁 项目

| 项目名 | 状态 | 下一步 | 进度文件 |
|--------|------|--------|----------|
| xxx | 进行中 | 完成xxx模块 | 项目/xxx-进度.md |
```

**状态值**：
- `规划中`
- `进行中`
- `待归档`
- `已归档`

### 回顾区域

```markdown
## 🔄 回顾

| 类型 | 最近完成 | 下次建议 | 状态 |
|------|----------|----------|------|
| 每日回顾 | 2024-02-05 | 今天 | ✅ 已完成 |
```

**状态值**：
- `✅ 已完成`
- `⬜ 待完成`
- `⏰ 已逾期`

---

## 五、代码示例

### 启动时读取全局状态

```
[AI 内部执行]

1. Read Meta/.ai-memory/全局状态.md
2. 解析相关区域
3. 生成提示信息
```

### 结束时更新全局状态

```
[AI 内部执行]

1. Read Meta/.ai-memory/全局状态.md
2. Edit 对应区域的状态
3. 如有需要，添加新的待处理条目
4. 更新"更新时间"字段
5. Write 保存文件
```

---

## 六、错误处理

### 全局状态文件不存在

如果 `Meta/.ai-memory/全局状态.md` 不存在：

1. 创建目录结构
2. 使用模板创建全局状态文件
3. 继续正常流程

### 进度文件不存在

如果对应的进度文件不存在：

1. 使用模板创建进度文件
2. 继续正常流程

### 状态不一致

如果发现全局状态与实际文件不一致：

1. 以实际文件为准
2. 更新全局状态文件
3. 提示用户发现了状态不一致并已修复
